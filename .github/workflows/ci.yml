name: CI

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - 'apps/docs/**'
      - '**/*.md'
      - '**/*.mdx'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - 'apps/docs/**'
      - '**/*.md'
      - '**/*.mdx'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.15.0'
  GO_VERSION: '1.24'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript type check
        run: pnpm exec tsc --noEmit --project apps/api/tsconfig.json

      - name: Run Astro check
        working-directory: apps/web
        run: pnpm exec astro check

  test-api:
    name: Test API
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run API tests
        run: pnpm test --filter=@breeze/api

  test-web:
    name: Test Web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Web tests
        run: pnpm test --filter=@breeze/web

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API
        run: pnpm build --filter=@breeze/api

      - name: Upload API artifact
        uses: actions/upload-artifact@v6
        with:
          name: api-dist
          path: apps/api/dist
          retention-days: 7

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Web
        run: pnpm build --filter=@breeze/web

      - name: Upload Web artifact
        uses: actions/upload-artifact@v6
        with:
          name: web-dist
          path: apps/web/dist
          retention-days: 7

  build-agent:
    name: Build Agent (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: ''
            cgo: '1'
          - goos: darwin
            goarch: amd64
            suffix: ''
            cgo: '0'
          - goos: darwin
            goarch: arm64
            suffix: ''
            cgo: '0'
          - goos: windows
            goarch: amd64
            suffix: '.exe'
            cgo: '0'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install libpcap (Linux)
        if: matrix.goos == 'linux'
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev libx11-dev libxext-dev

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: agent/go.sum

      - name: Download Go dependencies
        working-directory: agent
        run: go mod download

      - name: Build Agent
        working-directory: agent
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: ${{ matrix.cgo }}
          BUILD_VERSION: ${{ github.sha }}
        run: |
          go build -ldflags="-s -w -X main.version=${BUILD_VERSION}" \
            -o "breeze-agent-${GOOS}-${GOARCH}${{ matrix.suffix }}" \
            ./cmd/breeze-agent

      - name: Upload Agent artifact
        uses: actions/upload-artifact@v6
        with:
          name: breeze-agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: agent/breeze-agent-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }}
          retention-days: 7

  test-agent:
    name: Test Agent
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev libx11-dev libxext-dev

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: agent/go.sum

      - name: Download Go dependencies
        working-directory: agent
        run: go mod download

      - name: Run Go tests
        working-directory: agent
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: actions/upload-artifact@v6
        with:
          name: agent-coverage
          path: agent/coverage.out
          retention-days: 7

  # ─── E2E Tests ────────────────────────────────────────────────────────
  # Runs Playwright browser tests against the real API build artifact.
  # Web is rebuilt here with PUBLIC_API_URL because import.meta.env.PUBLIC_*
  # is baked in at Vite compile time and E2E has no reverse proxy.
  e2e:
    name: E2E Tests
    runs-on: self-hosted
    needs: [build-api]
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: breeze
          POSTGRES_PASSWORD: breeze_test
          POSTGRES_DB: breeze_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U breeze"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://breeze:breeze_test@localhost:5432/breeze_test
      REDIS_URL: redis://localhost:6379
      JWT_SECRET: e2e-k7x9Qm4pR2vL8nW5jT3yF6hB0cA1dE4gI7
      APP_ENCRYPTION_KEY: e2e-Xz9Lm3Kp7Wn2Qr5Tv8Yb0Hd4Fg6Jc1Ae3
      MFA_ENCRYPTION_KEY: e2e-Nm4Rp8Ws2Kv6Tq0Yh3Bd7Fg1Jc5Le9Ax2
      NODE_ENV: test
      E2E_BASE_URL: http://localhost:4321
      E2E_API_URL: http://localhost:3001
      # Must match apps/api/src/db/seed.ts seedDefaultAdmin()
      E2E_ADMIN_EMAIL: admin@breeze.local
      E2E_ADMIN_PASSWORD: BreezeAdmin123!
      # Baked into client JS at build time so the browser can reach the API
      PUBLIC_API_URL: http://localhost:3001

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install workspace dependencies
        run: pnpm install --frozen-lockfile

      # Download the real API production build
      - name: Download API artifact
        uses: actions/download-artifact@v6
        with:
          name: api-dist
          path: apps/api/dist

      # Build web with PUBLIC_API_URL for E2E (no reverse proxy in test)
      - name: Build Web (E2E)
        run: pnpm build --filter=@breeze/web

      - name: Install E2E dependencies
        working-directory: e2e-tests
        run: npm install

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('e2e-tests/package.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: e2e-tests
        run: npx playwright install --with-deps chromium

      - name: Install Playwright system deps (cache hit)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        working-directory: e2e-tests
        run: npx playwright install-deps chromium

      - name: Push database schema
        run: pnpm db:push

      - name: Seed test data
        run: pnpm db:seed

      - name: Start API server
        run: node apps/api/dist/index.cjs &
        env:
          PORT: 3001

      - name: Start Web server
        run: |
          cd apps/web
          HOST=0.0.0.0 PORT=4321 node dist/server/entry.mjs &

      - name: Wait for services
        run: |
          echo "Waiting for API on :3001..."
          timeout 30 bash -c 'until curl -sf http://localhost:3001/health 2>/dev/null; do sleep 1; done'
          echo "API is up."
          echo "Waiting for Web on :4321..."
          timeout 30 bash -c 'until curl -sf http://localhost:4321 2>/dev/null; do sleep 1; done'
          echo "Web is up."

      - name: Run Playwright tests
        working-directory: e2e-tests
        run: npx playwright test --reporter=list
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report
          path: e2e-tests/playwright-report/
          retention-days: 14

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-test-results
          path: e2e-tests/test-results/
          retention-days: 7

  # Summary job that depends on all other jobs for branch protection
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-api, test-web, build-api, build-web, build-agent, test-agent, e2e]
    if: always()
    steps:
      - name: Check all jobs passed
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TYPECHECK_RESULT: ${{ needs.typecheck.result }}
          TEST_API_RESULT: ${{ needs.test-api.result }}
          TEST_WEB_RESULT: ${{ needs.test-web.result }}
          BUILD_API_RESULT: ${{ needs.build-api.result }}
          BUILD_WEB_RESULT: ${{ needs.build-web.result }}
          BUILD_AGENT_RESULT: ${{ needs.build-agent.result }}
          TEST_AGENT_RESULT: ${{ needs.test-agent.result }}
          E2E_RESULT: ${{ needs.e2e.result }}
        run: |
          if [[ "${LINT_RESULT}" != "success" ]] || \
             [[ "${TYPECHECK_RESULT}" != "success" ]] || \
             [[ "${TEST_API_RESULT}" != "success" ]] || \
             [[ "${TEST_WEB_RESULT}" != "success" ]] || \
             [[ "${BUILD_API_RESULT}" != "success" ]] || \
             [[ "${BUILD_WEB_RESULT}" != "success" ]] || \
             [[ "${BUILD_AGENT_RESULT}" != "success" ]] || \
             [[ "${TEST_AGENT_RESULT}" != "success" ]] || \
             [[ "${E2E_RESULT}" != "success" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi
          echo "All required jobs passed!"
